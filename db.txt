-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.achievements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  badge_type character varying NOT NULL,
  points_awarded integer DEFAULT 0 CHECK (points_awarded >= 0),
  earned_at timestamp with time zone DEFAULT now(),
  CONSTRAINT achievements_pkey PRIMARY KEY (id),
  CONSTRAINT achievements_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.blood_bridges (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  name character varying NOT NULL,
  blood_group character varying NOT NULL CHECK (blood_group::text = ANY (ARRAY['A+'::character varying, 'A-'::character varying, 'B+'::character varying, 'B-'::character varying, 'O+'::character varying, 'O-'::character varying, 'AB+'::character varying, 'AB-'::character varying]::text[])),
  city character varying NOT NULL,
  rotation_position integer DEFAULT 1 CHECK (rotation_position >= 1),
  active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  active_request_id uuid,
  CONSTRAINT blood_bridges_pkey PRIMARY KEY (id),
  CONSTRAINT blood_bridges_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT blood_bridges_active_request_id_fkey FOREIGN KEY (active_request_id) REFERENCES public.emergency_requests(id)
);
CREATE TABLE public.bridge_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  bridge_id uuid,
  donor_id uuid,
  position integer NOT NULL CHECK ("position" >= 0),
  status character varying NOT NULL DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'inactive'::character varying, 'skipped'::character varying]::text[])),
  joined_at timestamp with time zone DEFAULT now(),
  rotation_order integer,
  CONSTRAINT bridge_members_pkey PRIMARY KEY (id),
  CONSTRAINT bridge_members_donor_id_fkey FOREIGN KEY (donor_id) REFERENCES public.users(id),
  CONSTRAINT bridge_members_bridge_id_fkey FOREIGN KEY (bridge_id) REFERENCES public.blood_bridges(id)
);
CREATE TABLE public.conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  message text NOT NULL,
  response text,
  created_at timestamp with time zone DEFAULT now(),
  user_phone character varying,
  CONSTRAINT conversations_pkey PRIMARY KEY (id),
  CONSTRAINT conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.donor_responses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  donor_id uuid,
  request_id uuid,
  response character varying NOT NULL CHECK (response::text = ANY (ARRAY['pending'::character varying, 'accepted'::character varying, 'declined'::character varying]::text[])),
  otp character varying,
  otp_expires_at timestamp with time zone,
  confirmed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT donor_responses_pkey PRIMARY KEY (id),
  CONSTRAINT donor_responses_request_id_fkey FOREIGN KEY (request_id) REFERENCES public.emergency_requests(id),
  CONSTRAINT donor_responses_donor_id_fkey FOREIGN KEY (donor_id) REFERENCES public.users(id)
);
CREATE TABLE public.emergency_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_name character varying NOT NULL,
  blood_group character varying NOT NULL CHECK (blood_group::text = ANY (ARRAY['A+'::character varying, 'A-'::character varying, 'B+'::character varying, 'B-'::character varying, 'O+'::character varying, 'O-'::character varying, 'AB+'::character varying, 'AB-'::character varying]::text[])),
  units_needed integer NOT NULL CHECK (units_needed > 0),
  hospital_name character varying NOT NULL,
  hospital_contact character varying,
  city character varying NOT NULL,
  urgency_level character varying DEFAULT 'high'::character varying CHECK (urgency_level::text = ANY (ARRAY['critical'::character varying, 'high'::character varying, 'medium'::character varying]::text[])),
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'fulfilled'::character varying, 'closed'::character varying, 'escalated'::character varying]::text[])),
  created_by uuid,
  requested_by_phone character varying NOT NULL,
  short_code character varying UNIQUE,
  units_confirmed integer DEFAULT 0 CHECK (units_confirmed >= 0),
  created_at timestamp with time zone DEFAULT now(),
  fulfilled_at timestamp with time zone,
  request_type character varying DEFAULT 'standard'::character varying CHECK (request_type::text = ANY (ARRAY['standard'::character varying, 'bridge'::character varying]::text[])),
  bridge_id uuid,
  latitude real,
  longitude real,
  patient_id uuid,
  CONSTRAINT emergency_requests_pkey PRIMARY KEY (id),
  CONSTRAINT emergency_requests_bridge_id_fkey FOREIGN KEY (bridge_id) REFERENCES public.blood_bridges(id),
  CONSTRAINT emergency_requests_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT emergency_requests_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.inbox_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_phone character varying NOT NULL,
  user_message text NOT NULL,
  reason character varying NOT NULL,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'resolved'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT now(),
  resolved_at timestamp with time zone,
  CONSTRAINT inbox_messages_pkey PRIMARY KEY (id)
);
CREATE TABLE public.knowledge_base (
  id integer NOT NULL DEFAULT nextval('knowledge_base_id_seq'::regclass),
  content text NOT NULL,
  category character varying,
  embedding jsonb,
  CONSTRAINT knowledge_base_pkey PRIMARY KEY (id)
);
CREATE TABLE public.patients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  phone character varying NOT NULL UNIQUE,
  blood_group character varying NOT NULL CHECK (blood_group::text = ANY (ARRAY['A+'::text, 'A-'::text, 'B+'::text, 'B-'::text, 'O+'::text, 'O-'::text, 'AB+'::text, 'AB-'::text, 'N/A'::text])),
  city character varying NOT NULL,
  pincode character varying,
  condition text,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'pending_opt_in'::character varying, 'pending_details'::character varying, 'pending_verification'::character varying, 'bridged'::character varying, 'active'::character varying]::text[])),
  last_transfusion_date date,
  frequency_in_days integer CHECK (frequency_in_days > 0),
  quantity_required integer DEFAULT 1 CHECK (quantity_required > 0),
  created_at timestamp with time zone DEFAULT now(),
  user_id uuid,
  CONSTRAINT patients_pkey PRIMARY KEY (id),
  CONSTRAINT patients_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.processed_messages (
  message_id character varying NOT NULL,
  processed_at timestamp with time zone DEFAULT now(),
  payload jsonb,
  CONSTRAINT processed_messages_pkey PRIMARY KEY (message_id)
);
CREATE TABLE public.schema_migrations (
  version character varying NOT NULL,
  applied_at timestamp with time zone DEFAULT now(),
  description text,
  CONSTRAINT schema_migrations_pkey PRIMARY KEY (version)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  phone character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  password character varying,
  blood_group character varying CHECK (blood_group::text = ANY (ARRAY['A+'::character varying, 'A-'::character varying, 'B+'::character varying, 'B-'::character varying, 'O+'::character varying, 'O-'::character varying, 'AB+'::character varying, 'AB-'::character varying, 'Unknown'::character varying]::text[])),
  city character varying,
  pincode character varying,
  user_type character varying NOT NULL CHECK (user_type::text = ANY (ARRAY['donor'::character varying, 'patient'::character varying, 'admin'::character varying]::text[])),
  role character varying DEFAULT 'Emergency Donor'::character varying,
  registration_status character varying DEFAULT 'completed'::character varying CHECK (registration_status::text = ANY (ARRAY['pending'::character varying, 'completed'::character varying]::text[])),
  availability_status character varying DEFAULT 'available'::character varying CHECK (availability_status::text = ANY (ARRAY['available'::character varying, 'unavailable'::character varying, 'on_hold'::character varying]::text[])),
  dnd_status boolean DEFAULT false,
  snooze_until timestamp with time zone,
  cooldown_until timestamp with time zone,
  last_donation date,
  donations_till_date integer DEFAULT 0 CHECK (donations_till_date >= 0),
  gamification_points integer DEFAULT 0 CHECK (gamification_points >= 0),
  streak_count integer DEFAULT 0 CHECK (streak_count >= 0),
  last_ml_score real,
  score_cached_at timestamp with time zone,
  last_request_short_code character varying,
  quiet_hours_start time without time zone,
  quiet_hours_end time without time zone,
  inactive_trigger_comment text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  notifications_received integer DEFAULT 0 CHECK (notifications_received >= 0),
  donations_confirmed integer DEFAULT 0 CHECK (donations_confirmed >= 0),
  latitude real,
  longitude real,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);